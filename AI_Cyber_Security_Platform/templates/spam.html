<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spam Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body>
    {% include 'header.html' %}

    <div class="container mt-4">
      <h1>Spam Detection</h1>
      <form id="spam-form">
        <div class="mb-3">
          <textarea id="text" class="form-control" rows="6" placeholder="Enter text or email body"></textarea>
        </div>
        <button class="btn btn-primary" type="submit">Check</button>
      </form>
      <div id="result" class="mt-3"></div>
      <div id="viz" class="mt-3"></div>
    </div>

    <script>
      document.getElementById('spam-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const text = document.getElementById('text').value;
        const r = await fetch('/api/spam', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
        const j = await r.json();
        const resultEl = document.getElementById('result');
        const vizEl = document.getElementById('viz');
        resultEl.innerHTML = '';
        vizEl.innerHTML = '';
        if(j && (j.label!==undefined || j.score!==undefined)){
          const badge = document.createElement('span');
          badge.className = 'badge fs-5';
          if(j.label === 'spam') badge.classList.add('bg-danger'); else badge.classList.add('bg-success');
          badge.innerText = (j.label === 'spam') ? 'Spam' : 'Not Spam';
          resultEl.appendChild(badge);
          if(j.score!==undefined && j.score!==null){
            const p = document.createElement('div');
            p.className = 'progress mt-3';
            const inner = document.createElement('div');
            inner.className = 'progress-bar';
            inner.style.width = Math.round(j.score*100)+'%';
            inner.innerText = Math.round(j.score*100)+'%';
            if(j.score>=0.5) inner.classList.add('bg-danger'); else inner.classList.add('bg-success');
            p.appendChild(inner);
            vizEl.appendChild(p);
          }
          if(j.reasons && j.reasons.length){
            const h = document.createElement('h6'); h.className='mt-3'; h.innerText='Why'; vizEl.appendChild(h);
            const ul = document.createElement('ul');
            for(const r of j.reasons){ const li = document.createElement('li'); li.innerText = r; ul.appendChild(li); }
            vizEl.appendChild(ul);
          }
          // actions: copy/download
          const actions = document.createElement('div');
          actions.className = 'mt-3';
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn btn-outline-secondary btn-sm me-2';
          copyBtn.innerText = 'Copy JSON';
          copyBtn.onclick = ()=>{ navigator.clipboard.writeText(JSON.stringify(j, null, 2)); };
          const dlBtn = document.createElement('button');
          dlBtn.className = 'btn btn-outline-primary btn-sm';
          dlBtn.innerText = 'Download JSON';
          dlBtn.onclick = ()=>{
            const blob = new Blob([JSON.stringify(j, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'spam_result.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          };
          actions.appendChild(copyBtn); actions.appendChild(dlBtn);
          vizEl.appendChild(actions);
        } else if(j && j.result){
          document.getElementById('result').innerText = j.result;
        } else {
          document.getElementById('result').innerText = JSON.stringify(j);
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
