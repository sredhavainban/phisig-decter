<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Phishing URL Detection</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
  </head>
  <body>
    {% include 'header.html' %}

    <div class="container mt-4">
      <h1>Phishing URL Detection</h1>
      <form id="url-form" class="row g-2">
        <div class="col-10">
          <input id="url" class="form-control" placeholder="https://example.com/path">
        </div>
        <div class="col-2">
          <button class="btn btn-primary w-100" type="submit">Check URL</button>
        </div>
      </form>
      <div id="result" class="mt-3"></div>
      <div id="viz" class="mt-3"></div>
      <div id="details" class="mt-3"></div>
    </div>

    <script>
      function renderResult(obj){
        const resultEl = document.getElementById('result');
        const vizEl = document.getElementById('viz');
        // clear
        resultEl.innerHTML = '';
        vizEl.innerHTML = '';

        const label = obj.label || obj.result || 'unknown';
        const score = (obj.score!==undefined && obj.score!==null) ? Number(obj.score) : null;

        // badge
        const badge = document.createElement('span');
        badge.className = 'badge fs-5';
        if(label === 'phishing') badge.classList.add('bg-danger');
        else if(label === 'legitimate') badge.classList.add('bg-success');
        else badge.classList.add('bg-secondary');
        badge.innerText = (label === 'phishing') ? 'Phishing URL' : (label === 'legitimate' ? 'Legitimate URL' : 'Unknown');
        resultEl.appendChild(badge);

        // score visualization: donut gauge + bar
        const detailsEl = document.getElementById('details');
        detailsEl.innerHTML = '';
        if(score !== null){
          // donut SVG
          const svgNS = 'http://www.w3.org/2000/svg';
          const size = 120;
          const r = 50;
          const c = 2 * Math.PI * r;
          const svg = document.createElementNS(svgNS,'svg');
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          const bg = document.createElementNS(svgNS,'circle');
          bg.setAttribute('cx', size/2);
          bg.setAttribute('cy', size/2);
          bg.setAttribute('r', r);
          bg.setAttribute('fill','none');
          bg.setAttribute('stroke','#eee');
          bg.setAttribute('stroke-width','12');
          svg.appendChild(bg);
          const arc = document.createElementNS(svgNS,'circle');
          arc.setAttribute('cx', size/2);
          arc.setAttribute('cy', size/2);
          arc.setAttribute('r', r);
          arc.setAttribute('fill','none');
          arc.setAttribute('stroke-width','12');
          arc.setAttribute('stroke-linecap','round');
          arc.setAttribute('transform', `rotate(-90 ${size/2} ${size/2})`);
          arc.setAttribute('stroke-dasharray', c);
          const offset = Math.round((1 - score) * c);
          arc.setAttribute('stroke-dashoffset', offset);
          arc.setAttribute('stroke', score>=0.5 ? '#dc3545' : '#198754');
          svg.appendChild(arc);
          const txt = document.createElementNS(svgNS,'text');
          txt.setAttribute('x', size/2);
          txt.setAttribute('y', size/2 + 6);
          txt.setAttribute('text-anchor','middle');
          txt.setAttribute('font-size','16');
          txt.setAttribute('fill','#333');
          txt.textContent = Math.round(score*100) + '%';
          svg.appendChild(txt);
          vizEl.appendChild(svg);

          // horizontal bar
          const p = document.createElement('div');
          p.className = 'progress mt-3';
          const inner = document.createElement('div');
          inner.className = 'progress-bar';
          inner.style.width = Math.round(score*100)+'%';
          inner.setAttribute('role','progressbar');
          inner.setAttribute('aria-valuenow', Math.round(score*100));
          inner.setAttribute('aria-valuemin','0');
          inner.setAttribute('aria-valuemax','100');
          inner.innerText = Math.round(score*100)+'% phishing-score';
          if(score>=0.5) inner.classList.add('bg-danger'); else inner.classList.add('bg-success');
          p.appendChild(inner);
          vizEl.appendChild(p);

          // reasons
          if(obj.reasons && obj.reasons.length){
            const h = document.createElement('h6');
            h.className = 'mt-3';
            h.innerText = 'Why this looks suspicious';
            detailsEl.appendChild(h);
            const ul = document.createElement('ul');
            for(const r of obj.reasons){
              const li = document.createElement('li');
              li.innerText = r;
              ul.appendChild(li);
            }
            detailsEl.appendChild(ul);
          }

          // actions: copy/download
          const actions = document.createElement('div');
          actions.className = 'mt-3';
          const copyBtn = document.createElement('button');
          copyBtn.className = 'btn btn-outline-secondary btn-sm me-2';
          copyBtn.innerText = 'Copy JSON';
          copyBtn.onclick = ()=>{ navigator.clipboard.writeText(JSON.stringify(obj, null, 2)); };
          const dlBtn = document.createElement('button');
          dlBtn.className = 'btn btn-outline-primary btn-sm';
          dlBtn.innerText = 'Download JSON';
          dlBtn.onclick = ()=>{
            const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'phishing_result.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          };
          actions.appendChild(copyBtn); actions.appendChild(dlBtn);
          detailsEl.appendChild(actions);

          // features table
          if(obj.features && obj.features.length){
            const h2 = document.createElement('h6');
            h2.className = 'mt-3';
            h2.innerText = 'Top features (index:value)';
            detailsEl.appendChild(h2);
            const table = document.createElement('table');
            table.className = 'table table-sm table-striped';
            const tbody = document.createElement('tbody');
            for(let i=0;i<Math.min(20,obj.features.length);i++){
              const tr = document.createElement('tr');
              const td1 = document.createElement('td'); td1.innerText = i;
              const td2 = document.createElement('td'); td2.innerText = obj.features[i];
              tr.appendChild(td1); tr.appendChild(td2);
              tbody.appendChild(tr);
            }
            table.appendChild(tbody);
            detailsEl.appendChild(table);
          }
        } else {
          const msg = document.createElement('div');
          msg.className = 'text-muted mt-2';
          msg.innerText = 'No score available â€” showing features.';
          vizEl.appendChild(msg);
          if(obj.features) {
            const pre = document.createElement('pre');
            pre.style.maxHeight='200px';
            pre.style.overflow='auto';
            pre.innerText = JSON.stringify(obj.features.slice(0,50), null, 2);
            vizEl.appendChild(pre);
          }
        }
      }

      document.getElementById('url-form').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const url = document.getElementById('url').value;
        const r = await fetch('/api/phishing-url', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
        const j = await r.json();
        // server may return {label,score,features} or {result: '...'}
        if(j && (j.label!==undefined || j.score!==undefined || j.features!==undefined)){
          renderResult(j);
        } else if(j && j.result){
          // try to parse JSON string in result
          try{
            const parsed = JSON.parse(j.result);
            renderResult(parsed);
          }catch(_){
            document.getElementById('result').innerText = j.result;
          }
        } else {
          document.getElementById('result').innerText = JSON.stringify(j);
        }
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
